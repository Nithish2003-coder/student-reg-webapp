properties([pipelineTriggers([githubPush()])])

node {
    def mavenHome = tool name: 'Maven-3.9.11', type: 'maven'
    def tomcatserver = "172.31.14.189"
    def tomcatSSHusername = "ec2-user"

    try {

        stage ("git clone") {
            git branch: 'main',
                credentialsId: 'githubcredentials',
                url: 'https://github.com/Nithish2003-coder/student-reg-webapp.git'
        }

        stage ("maven build") {
            sh "${mavenHome}/bin/mvn clean package"
        }

        stage ("sonar scan") {
            withCredentials([string(credentialsId: 'sonartoken', variable: 'sonarqubetoken')]) {
                sh "${mavenHome}/bin/mvn sonar:sonar -Dsonar.login=$sonarqubetoken"
            }
        }

        stage ("upload war file to nexus") {
            sh "${mavenHome}/bin/mvn clean deploy"
        }

        stage ("deploy to tomcat") {
            sshagent(['TomcatServer_SSH_credentials']) {
                sh """
                ssh -o StrictHostKeyChecking=no ${tomcatSSHusername}@${tomcatserver} sudo systemctl stop tomcat || true
                sleep 20
                ssh -o StrictHostKeyChecking=no ${tomcatSSHusername}@${tomcatserver} rm -f /opt/tomcat/webapps/student-reg-webapp.war
                scp -o StrictHostKeyChecking=no target/student-reg-webapp.war ${tomcatSSHusername}@${tomcatserver}:/opt/tomcat/webapps/student-reg-webapp.war
                ssh -o StrictHostKeyChecking=no ${tomcatSSHusername}@${tomcatserver} sudo systemctl start tomcat
                """
            }
        }

    } catch (err) {
        currentBuild.result = 'FAILURE'
        throw err
    } finally {

        def buildstatus = currentBuild.result ?: "SUCCESS"

        emailext(
            mimeType: 'text/html',
            subject: "${env.JOB_NAME} - Build #${env.BUILD_NUMBER} - ${buildstatus}",
            to: "nithishchapireedy184@gmail.com",
            body: "Build Status: ${buildstatus}<br/>${env.BUILD_URL}"
        )
    }
}
